# android/fastlane/Fastfile
# Run from the android/ directory: bundle exec fastlane <lane_name>

default_platform(:android)

platform :android do

  AAB_PATH = "../build/app/outputs/bundle/release/app-release.aab"

  # â”€â”€â”€ ICONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  desc "Generate app icons from assets/icon/diwan-ankara-1024x1024.png"
  lane :generate_icons do
    sh("cd .. && flutter pub get && dart run flutter_launcher_icons")
    UI.success("âœ… Icons generated!")
  end

  # â”€â”€â”€ TEST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  desc "Run Flutter unit tests"
  lane :test do
    sh("cd .. && flutter test --coverage")
    UI.success("âœ… Tests passed!")
  end

  # â”€â”€â”€ VERSION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  desc "Bump versionCode in pubspec.yaml"
  lane :bump_version do
    pubspec_path = "../pubspec.yaml"
    content = File.read(pubspec_path)
    current = content.match(/^version:\s+(\d+\.\d+\.\d+)\+(\d+)/)
    UI.user_error!("Could not parse version in pubspec.yaml") unless current
    version_name = current[1]
    version_code = current[2].to_i + 1
    File.write(pubspec_path, content.gsub(/^version:\s+\S+/, "version: #{version_name}+#{version_code}"))
    UI.success("âœ… Bumped to #{version_name}+#{version_code}")
    version_code
  end

  # â”€â”€â”€ BUILD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  desc "Build Flutter release AAB"
  lane :build do
    sh("cd .. && flutter clean && flutter pub get && flutter build appbundle --release")
    UI.success("âœ… AAB built!")
  end

  # â”€â”€â”€ DEPLOY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  desc "Deploy to Internal Testing track"
  lane :deploy_internal do
    test; bump_version; build
    upload_to_play_store(track: "internal", aab: AAB_PATH, release_status: "draft")
    UI.success("ðŸš€ Internal deployed!")
  end

  desc "Deploy to Alpha track"
  lane :deploy_alpha do
    test; bump_version; build
    upload_to_play_store(track: "alpha", aab: AAB_PATH, release_status: "completed")
    UI.success("ðŸš€ Alpha deployed!")
  end

  desc "Deploy to Beta track"
  lane :deploy_beta do
    test; bump_version; build
    upload_to_play_store(track: "beta", aab: AAB_PATH, release_status: "completed")
    UI.success("ðŸš€ Beta deployed!")
  end

  desc "Deploy to Production (10% staged rollout)"
  lane :deploy_production do
    test; bump_version; build
    upload_to_play_store(track: "production", aab: AAB_PATH, release_status: "completed", rollout: "0.1")
    UI.success("ðŸŽ‰ Production deployed!")
  end

  # â”€â”€â”€ PROMOTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  desc "Promote Internal â†’ Alpha (no re-upload)"
  lane :promote_internal_to_alpha do
    upload_to_play_store(track: "internal", track_promote_to: "alpha")
    UI.success("âœ… Internal â†’ Alpha")
  end

  desc "Promote Alpha â†’ Beta (no re-upload)"
  lane :promote_alpha_to_beta do
    upload_to_play_store(track: "alpha", track_promote_to: "beta")
    UI.success("âœ… Alpha â†’ Beta")
  end

  desc "Promote Beta â†’ Production (no re-upload)"
  lane :promote_beta_to_production do
    upload_to_play_store(track: "beta", track_promote_to: "production", rollout: "0.1")
    UI.success("ðŸŽ‰ Beta â†’ Production")
  end

end
